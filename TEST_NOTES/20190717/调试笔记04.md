# 调试笔记04
小车反应过慢，是陀螺仪的问题。原因是代码中存在`delay(1000)`这样的延迟函数，导致反应过慢。倘若没有`delay()`还是反应过慢，则需要优化代码结构，把中断需要执行的函数往后放。 

**最终小车平衡的参数**：  

ZHONGZHI = -2.5  
Balance_kp = 10  
Balance_kd = 0.3  
Velocity_kp = 2  
Velocity_kd = 0.01  
turn_kp = 2   
turn_kd = 0.001  
Amplitude = 20

## 总结
之前的问题是，小车调试直立的时候没有问题，出现大幅度低频抖动和高频抖动，分别找到了对应的kp和kd，乘以0.6之后，再加上速度环，发现小车一运动就会倒，两边都会。**这是由于速度环出了问题**。

解决方法是：

1. 其它环均置零，只留速度环，一般给(kp, kd) = (2, 0.01)就可以。（**这里给了正的**）
2. 上传程序后，只用电池供电，用手轻轻拨弄轮胎。正常情况是，比如往前拨，轮胎会迅速跟上（往前转），直至转到最大限幅值；反向同理。说明上述的设置（**pd参数为正**）是正确的；倘若往前拨结果轮胎往后转，往后拨轮胎往前转，说明极性设置错误，应设为**负值**。

    + 所以如果是上面的情况，更改极性即可，再稍微调整一下速度环的pd值，很快小车就会平衡。
    + 如果**无论用手怎么转动，电机就是不转**，那么有以下的解决方法。

3. 确认电机的A、B相引脚，找到程序最前面定义的编码器（`ENCODER`）引脚，随后到`setup()`函数中的最后找到
```c
attachInterrupt(1, READ_ENCODER_L, CHANGE);           //开启外部中断 编码器接口1
  // 硬件中断，需要接2或3号引脚
  // A电机编码器引脚为3
  // 3号引脚，中断号为1
  // 2号引脚，中断号为0
attachPinChangeInterrupt(4, READ_ENCODER_R, CHANGE);  //开启外部中断 编码器接口2
  // 软件中断，接数字引脚即可
  // B电机编码器引脚为4
```
`CHANGE`表示中断触发为跳变，也有`HIGH`（高电平触发）和`LOW`（低电平触发）。  
将对应的引脚号改成自己对应的。

4. 如果上述有问题，请修改，再回到第一步进行测试。

5. 没有问题的话，找到`control()`函数里的速度控制，在后面加上串口输出。
```c
if (++VelocityCount >= 8) //速度控制，控制周期40ms
  {
    Velocity_Left = Velocity_L;    Velocity_L = 0;  
    //读取左轮编码器数据，并清零
    //这就是通过M法测速（单位时间内的脉冲数）得到速度。
    Velocity_Right = Velocity_R;    Velocity_R = 0; //读取右轮编码器数据，并清零
    Velocity_Pwm = velocity(Velocity_Left, Velocity_Right);//速度PI控制，控制周期40ms
    VelocityCount = 0;

    // 以下为添加的串口输出
    Serial.print("Left："); Serial.println(Velocity_Left);
    Serial.print("Right："); Serial.println(Velocity_Right);
    delay(1000);
    //Serial.println(Velocity_Pwm);
  }
```
6. 上传程序，打开串口，查看输出。
    + 串口输出为0，那么**硬件或者连线一定有问题**，需要重新检查小车的搭建
    + 串口输出一个为0，一个有数值，那么第3步有问题，需要重新确认。
    + 左右轮都有数据，但是两个数值相近，符号相反，这时候需要将第5步中的`Velocity_Left = Velocity_L;    Velocity_L = 0;  `改成`Velocity_Left = -Velocity_L;    Velocity_L = 0;  //`，改完之后再次上传，查看，没问题返回第一步
    + 左右轮都有数据，但是两个数值相差较大。**硬件有问题！**
    + 左右轮都有数据，且两个数值相差不大，同符号。那么程序中有除了速度环还有控制电机的函数（比如陀螺仪），或者有`delay()`函数，或者有串口输入控制电机，等等等等。**这是程序的问题**
7. 以上检查完，应该就能发现问题并进行修改了。

速度环的问题解决了之后，应该就很快能控制小车了，那么可能又会出现一个问题——**蓝牙控制小车前进后退都没问题，可是转弯却有问题**。

分情况讨论一下：

1. 蓝牙发送转弯指令，小车根本没有反应，不用怀疑，**转向环的pd参数为0**，给其赋一定的值即可。
2. 蓝牙发送转弯指令，小车却在原地打转（左转、右转都打转）。这个原因是由于转向限幅设置的偏大，导致小车转向速度偏快，所以才会打转。解决方法是修改`turn()`（即转向函数）中的转向限幅，降低即可。

## 结语
调试过程到此结束了，一路做下来就可以实现小车的平衡，与蓝牙的控制。其他的比如显示屏、红外线...辅助功能，有时间的可以添加，这些就很简单了。
